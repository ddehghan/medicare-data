{% extends 'theme/base.html' %}
{% load i18n %}

{% trans "This is the title" as the_title %}

{% block meta_description %}{{ the_title }}{% endblock %}
{% block title %}{{ the_title }}{% endblock %}

{% block extra_css %}

    <style>
        path {
            stroke: white;
            stroke-width: 0.25px;
            fill: grey;
        }
    </style>
    <script src="{{ STATIC_URL }}js/d3.v3.min.js"></script>
    <script src="{{ STATIC_URL }}js/topojson.v0.min.js"></script>

    <script src="{{ STATIC_URL }}js/jquery.tipsy.js"></script>

    <link href="{{ STATIC_URL }}css/tipsy.css" rel="stylesheet">

{% endblock %}


{% block maincontent %}

    <h1>Data:</h1>

    <br>
    <div>
        <select id="drug_name" style="display: inline; width: 700px;">
            <option value="1" selected="selected">247 - PERC CARDIOVASC PROC W DRUG-ELUTING STENT W/O MCC</option>
            <option value="2">039 - EXTRACRANIAL PROCEDURES W/O CC/MCC</option>
            <option value="3">291 - HEART FAILURE & SHOCK W MCC</option>
        </select>
        <img id="spinner" src="{{ STATIC_URL }}images/ajax-loader.gif" style="visibility: hidden;display: inline;">
        <button type="button" onclick="spinner_on()" style="display: inline;">ON</button>
        <button type="button" onclick="spinner_off()" style="display: inline;">OFF</button>
    </div>
    <div id="chart"></div>



{% endblock %}


{% block bottomscript %}
    <script>

        {#    http://www.schneidy.com/Tutorials/MapsTutorial.html#}

        function draw_chart(drug) {
            var width = 960,
                    height = 500;

            var svg = d3.select("#chart").append("svg")
                    .attr("width", width)
                    .attr("height", height);

            var group = svg.append("g");

            var projection = d3.geo.albersUsa();
            group.attr('transorm', 'scale(.3, .3)');

            d3.json('{{ STATIC_URL }}json/us-states.json', function (collection) {
                group.selectAll('path')
                        .data(collection.features)
                        .enter().append('path')
                        .attr('d', d3.geo.path().projection(projection))
                        .attr('id', function (d) {
                            return d.properties.name.replace(/\s+/g, '')
                        })
                        .style('fill', 'gray')
                        .style('stroke', 'white')
                        .style('stroke-width', 1);

                d3.csv("charges/" + drug, function (error, data) {
                    group.selectAll("circle")
                            .data(data)
                            .enter()
                            .append("circle")
                            .attr("cx", function (d) {
                                return projection([d.lon, d.lat])[0];
                            })
                            .attr("cy", function (d) {
                                return projection([d.lon, d.lat])[1];
                            })
                            .attr("r", function (d) {
                                return d.size;
                            })
                            .style("fill", "red");

                    $('svg circle').tipsy({
                        gravity: 'w',
                        html: true,
                        title: function () {
                            var d = this.__data__;

                            return d.name;
                        }
                    });


                });
            });
        }

        var e = document.getElementById("drug_name");
        var drug = e.options[e.selectedIndex].text;

        function spinner_on() {
            $("svg").remove();
            $("#spinner").css("visibility", "inherit");
            draw_chart(drug);

        }
        function spinner_off() {
            $("#spinner").css("visibility", "hidden");
        }


        // zoom and pan
        //var zoom = d3.behavior.zoom()
        //    .on("zoom",function() {
        //        g.attr("transform","translate("+
        //            d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        //        g.selectAll("circle")
        //            .attr("d", path.projection(projection));
        //        g.selectAll("path")
        //            .attr("d", path.projection(projection));
        <!---->
        //  });
        <!---->
        //svg.call(zoom)

    </script>
{% endblock %}
